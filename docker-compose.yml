services:
  mysql:
    image: mysql:8.0
    container_name: ps-mysql
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: prestashop
      MYSQL_USER: prestashop
      MYSQL_PASSWORD: prestashop123
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3307:3306"

  web:
    image: php:8.1-apache
    container_name: ps-web
    depends_on:
      mysql:
        condition: service_started
    ports:
      - "8080:80"
    volumes:
      # THIS IS THE IMPORTANT LINE → mounts your local folder directly
      - .:/var/www/html
    working_dir: /var/www/html
    command:
      - bash
      - -c
      - |
        # Only extract the ZIP the very first time
        if [ ! -f install/index.php ] && [ -f /tmp/prestashop.zip ]; then
          echo "First start – extracting PrestaShop 8.2.3 into your local folder..."
          unzip -q /tmp/prestashop.zip -d .
          chown -R www-data:www-data .
        fi

        # Install system packages
        apt-get update -qq
        apt-get install -y --no-install-recommends unzip libzip-dev libpng-dev libjpeg-dev libfreetype6-dev libicu-dev > /dev/null 2>&1

        # PHP extensions
        docker-php-ext-configure gd --with-freetype --with-jpeg
        docker-php-ext-install -j$(nproc) mysqli pdo_mysql zip gd intl bcmath > /dev/null 2>&1

        # PHP settings
        echo "short_open_tag = Off" > /usr/local/etc/php/conf.d/custom.ini
        echo "date.timezone = Europe/Paris" >> /usr/local/etc/php/conf.d/custom.ini

        # Apache
        a2enmod rewrite > /dev/null

        apache2-foreground

volumes:
  mysql-data:
